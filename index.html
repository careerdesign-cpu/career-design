<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0b0f1a;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif}
    .bar{height:56px;display:flex;gap:10px;align-items:center;padding:10px 12px;background:#111827;border-bottom:1px solid #223046;position:sticky;top:0;z-index:10}
    .btn{height:36px;padding:0 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e5e7eb;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .mini{height:36px;width:76px;text-align:center;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#e5e7eb;outline:none}
    .label{color:#9ca3af;font-size:12px}
    .spacer{flex:1}
    #wrap{height:calc(100vh - 56px);overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:18px}
    #canvas{max-width:100%;border-radius:12px;box-shadow:0 10px 26px rgba(0,0,0,.35);background:#111}
    .err{max-width:900px;margin:12px auto;padding:12px 14px;border-radius:12px;border:1px solid rgba(239,68,68,.5);background:rgba(239,68,68,.12);color:#fecaca;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
  <div class="bar">
    <button class="btn" id="prevBtn">◀</button>
    <input class="mini" id="pageInput" value="1" inputmode="numeric" />
    <span class="label">/ <span id="pageCount">-</span></span>
    <button class="btn" id="nextBtn">▶</button>

    <div class="spacer"></div>

    <span class="label" id="status">로딩 준비…</span>
    <button class="btn" id="openPdfBtn">PDF 직접열기</button>
  </div>

  <div id="err" class="err"></div>

  <div id="wrap">
    <canvas id="canvas"></canvas>
  </div>

  <!-- ✅ 로컬 pdf.js (CDN 차단 이슈 제거) -->
  <script src="vendor/pdf.min.js"></script>
  <script>
    const PDF_URL = "assets/proposal.pdf";

    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInput = document.getElementById("pageInput");
    const pageCountEl = document.getElementById("pageCount");
    const openPdfBtn = document.getElementById("openPdfBtn");

    openPdfBtn.onclick = () => window.open(PDF_URL, "_blank", "noopener,noreferrer");

    function showErr(e){
      errEl.style.display = "block";
      errEl.textContent = String(e && e.message ? e.message : e);
      statusEl.textContent = "로딩 실패";
    }

    // worker 경로도 로컬로 고정
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "vendor/pdf.worker.min.js";
    } else {
      showErr("pdf.min.js 로드 실패 (vendor/pdf.min.js 확인)");
    }

    let pdfDoc = null;
    let pageNum = 1;
    let rendering = false;

    async function renderPage(num){
      if (!pdfDoc) return;
      rendering = true;
      statusEl.textContent = "렌더링 중…";

      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: 1.6 });

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      const renderTask = page.render({ canvasContext: ctx, viewport });
      await renderTask.promise;

      pageInput.value = String(num);
      pageCountEl.textContent = String(pdfDoc.numPages);
      prevBtn.disabled = num <= 1;
      nextBtn.disabled = num >= pdfDoc.numPages;

      statusEl.textContent = "완료";
      rendering = false;
    }

    async function init(){
      try{
        statusEl.textContent = "PDF 확인 중…";
        const r = await fetch(PDF_URL);
        if (!r.ok) throw new Error(`PDF 접근 실패: ${r.status} ${r.statusText}\n경로: ${PDF_URL}`);
        statusEl.textContent = "PDF 로딩 중…";

        const loadingTask = pdfjsLib.getDocument({ url: PDF_URL });
        pdfDoc = await loadingTask.promise;

        pageCountEl.textContent = String(pdfDoc.numPages);
        await renderPage(pageNum);

        prevBtn.onclick = async () => {
          if (rendering || pageNum <= 1) return;
          pageNum--;
          await renderPage(pageNum);
        };
        nextBtn.onclick = async () => {
          if (rendering || pageNum >= pdfDoc.numPages) return;
          pageNum++;
          await renderPage(pageNum);
        };
        pageInput.addEventListener("keydown", async (e) => {
          if (e.key !== "Enter") return;
          const n = parseInt(pageInput.value, 10);
          if (!Number.isFinite(n)) return;
          pageNum = Math.min(Math.max(1, n), pdfDoc.numPages);
          await renderPage(pageNum);
        });

      } catch(e){
        console.error(e);
        showErr(e);
      }
    }

    init();
  </script>
</body>
</html>