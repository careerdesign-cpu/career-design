<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .topbar{
      height:52px; display:flex; align-items:center; gap:10px;
      padding:0 12px; border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:sticky; top:0; z-index:10;
    }
    .btn{
      height:34px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:#e5e7eb; cursor:pointer;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .input{
      height:34px; width:64px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:#e5e7eb; text-align:center;
    }
    .spacer{flex:1}
    .wrap{height:calc(100% - 52px); display:flex}
    .sidebar{
      width:220px; border-right:1px solid rgba(255,255,255,.08);
      overflow:auto; padding:10px; box-sizing:border-box;
    }

    /* 썸네일 플레이스홀더 */
    .thumb-wrap{
      width:100%; margin-bottom:10px; border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      cursor:pointer; overflow:hidden; position:relative;
      aspect-ratio: 210 / 297; /* A4 비율 기본값, 렌더 후 교체 */
    }
    .thumb-wrap canvas{
      display:block; width:100%; height:auto;
      border:none; box-shadow:none; border-radius:0; background:transparent;
    }
    .thumb-wrap.active{
      border-color: #6366f1;
      box-shadow: 0 0 0 2px #6366f155;
    }
    /* 썸네일 로딩 스켈레톤 애니메이션 */
    .thumb-wrap::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg,transparent 25%,rgba(255,255,255,.06) 50%,transparent 75%);
      background-size:200% 100%;
      animation:shimmer 1.4s infinite;
    }
    .thumb-wrap.loaded::before{ display:none; }
    @keyframes shimmer{ to{ background-position:-200% 0; } }

    .viewer{
      flex:1; overflow:auto; display:flex; justify-content:center; align-items:flex-start;
      padding:16px; box-sizing:border-box;
    }

    /* 메인 캔버스 래퍼 (로딩 오버레이용) */
    .canvas-wrap{ position:relative; }
    .canvas-wrap .loading-overlay{
      position:absolute; inset:0; border-radius:12px;
      background:rgba(11,18,32,.7);
      display:flex; align-items:center; justify-content:center;
      font-size:14px; color:#9ca3af; transition:opacity .2s;
    }
    .canvas-wrap .loading-overlay.hidden{ opacity:0; pointer-events:none; }

    canvas#canvas{
      display:block;
      border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#111827;
      box-shadow:0 12px 50px rgba(0,0,0,.35);
      max-width:100%; height:auto;
    }
    .msg{
      position:fixed; left:50%; top:70px; transform:translateX(-50%);
      padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(239,68,68,.15); color:#fecaca; display:none; z-index:20;
      max-width:min(820px, calc(100% - 24px)); white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="msg" id="msg"></div>

  <div class="topbar">
    <button class="btn" id="prev">◀</button>
    <div>
      <input class="input" id="page" value="1" />
      <span id="pageCount">/ ?</span>
    </div>
    <button class="btn" id="next">▶</button>
    <button class="btn" id="zoomOut">－</button>
    <button class="btn" id="zoomIn">＋</button>
    <div class="spacer"></div>
    <button class="btn" id="openPdf">PDF 직접열기</button>
  </div>

  <div class="wrap">
    <div class="sidebar" id="sidebar"></div>
    <div class="viewer">
      <div class="canvas-wrap">
        <canvas id="canvas"></canvas>
        <div class="loading-overlay" id="overlay">렌더링 중...</div>
      </div>
    </div>
  </div>

  <script src="vendor/pdf.min.js"></script>
  <script>
    const PDF_URL    = "assets/proposal.pdf";
    const WORKER_URL = "vendor/pdf.worker.min.js";

    // ── 유틸 ──────────────────────────────────────────
    const $   = (id) => document.getElementById(id);
    const msg = $("msg");
    const showMsg = (t) => { msg.textContent = t; msg.style.display = "block"; };
    const hideMsg = () => { msg.style.display = "none"; };

    if (!window.pdfjsLib) {
      showMsg("pdfjsLib is not defined\n\nvendor/pdf.min.js 를 확인하세요.");
      throw new Error("pdfjsLib is not defined");
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;

    // ── 상태 ──────────────────────────────────────────
    let pdfDoc      = null;
    let currentPage = 1;
    let scale       = 1.2;
    let rendering   = false;   // 동시 렌더 방지
    let pendingPage = null;    // 렌더 대기 페이지

    const canvas  = $("canvas");
    const ctx     = canvas.getContext("2d");
    const overlay = $("overlay");
    const sidebar = $("sidebar");

    // 페이지별 렌더링 Promise 캐시 (썸네일)
    const thumbCache = new Map();
    // IntersectionObserver로 뷰포트에 들어올 때만 썸네일 렌더
    let thumbObserver = null;

    // ── 메인 페이지 렌더 ──────────────────────────────
    async function renderPage(pageNum) {
      if (rendering) { pendingPage = pageNum; return; }
      rendering = true;
      overlay.classList.remove("hidden");

      try {
        const page     = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale });
        canvas.width   = Math.floor(viewport.width);
        canvas.height  = Math.floor(viewport.height);

        await page.render({ canvasContext: ctx, viewport }).promise;

        currentPage = pageNum;
        $("page").value          = String(pageNum);
        $("pageCount").textContent = `/ ${pdfDoc.numPages}`;
        $("prev").disabled = currentPage <= 1;
        $("next").disabled = currentPage >= pdfDoc.numPages;

        // 사이드바 active 표시
        sidebar.querySelectorAll(".thumb-wrap").forEach((el, i) => {
          el.classList.toggle("active", i + 1 === pageNum);
        });
      } finally {
        rendering = false;
        overlay.classList.add("hidden");

        // 대기 중인 페이지가 있으면 바로 렌더
        if (pendingPage !== null) {
          const next = pendingPage;
          pendingPage = null;
          renderPage(next);
        }
      }
    }

    // ── 썸네일 1장 렌더 ───────────────────────────────
    async function renderThumb(wrap, pageNum) {
      if (thumbCache.has(pageNum)) return; // 이미 렌더됨
      thumbCache.set(pageNum, true);

      const page     = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1 });
      const thumbScale = 190 / viewport.width;
      const tv   = page.getViewport({ scale: thumbScale });

      const c    = document.createElement("canvas");
      c.width    = Math.floor(tv.width);
      c.height   = Math.floor(tv.height);
      await page.render({ canvasContext: c.getContext("2d"), viewport: tv }).promise;

      wrap.appendChild(c);
      wrap.classList.add("loaded");
    }

    // ── 썸네일 플레이스홀더 빌드 (즉시 / 렌더는 lazy) ──
    function buildThumbPlaceholders() {
      sidebar.innerHTML = "";
      thumbCache.clear();

      // IntersectionObserver: 뷰포트에 들어올 때 렌더
      thumbObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;
          const wrap    = entry.target;
          const pageNum = parseInt(wrap.dataset.page, 10);
          renderThumb(wrap, pageNum);
          thumbObserver.unobserve(wrap); // 한 번만
        });
      }, { root: sidebar, rootMargin: "200px" });

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const wrap = document.createElement("div");
        wrap.className   = "thumb-wrap";
        wrap.dataset.page = String(i);
        wrap.title       = `Page ${i}`;
        wrap.addEventListener("click", () => renderPage(i));
        sidebar.appendChild(wrap);
        thumbObserver.observe(wrap);
      }
    }

    // ── PDF 로드 ──────────────────────────────────────
    async function loadPdf() {
      try {
        // 1) 문서 로드
        pdfDoc = await pdfjsLib.getDocument({
          url: PDF_URL,
          // 사전 로드 범위 축소 → 초기 응답 빠름
          rangeChunkSize: 65536,
          disableAutoFetch: false,
          disableStream: false,
        }).promise;

        $("pageCount").textContent = `/ ${pdfDoc.numPages}`;

        // 2) 첫 페이지 렌더 (썸네일보다 먼저)
        await renderPage(1);

        // 3) 썸네일 플레이스홀더 생성 (비동기 lazy 렌더)
        buildThumbPlaceholders();

      } catch (e) {
        showMsg(
          "PDF 로딩 실패\n\n" +
          `- ${PDF_URL} 경로 확인\n` +
          `- ${WORKER_URL} 확인\n\n` +
          "에러:\n" + (e?.message || String(e))
        );
        console.error(e);
      }
    }

    // ── 이벤트 ────────────────────────────────────────
    $("prev").addEventListener("click", () =>
      renderPage(Math.max(1, currentPage - 1)));
    $("next").addEventListener("click", () =>
      renderPage(Math.min(pdfDoc?.numPages ?? 1, currentPage + 1)));

    $("zoomIn").addEventListener("click",  async () => { scale = Math.min(3.0, scale + 0.15); await renderPage(currentPage); });
    $("zoomOut").addEventListener("click", async () => { scale = Math.max(0.6, scale - 0.15); await renderPage(currentPage); });

    $("page").addEventListener("keydown", async (e) => {
      if (e.key !== "Enter" || !pdfDoc) return;
      const n = parseInt(e.target.value, 10);
      if (Number.isFinite(n) && n >= 1 && n <= pdfDoc.numPages) renderPage(n);
    });

    $("openPdf").addEventListener("click", () => window.open(PDF_URL, "_blank"));

    // 키보드 화살표 지원
    document.addEventListener("keydown", (e) => {
      if (!pdfDoc) return;
      if (e.key === "ArrowRight" || e.key === "ArrowDown")
        renderPage(Math.min(pdfDoc.numPages, currentPage + 1));
      if (e.key === "ArrowLeft"  || e.key === "ArrowUp")
        renderPage(Math.max(1, currentPage - 1));
    });

    // ── 시작 ──────────────────────────────────────────
    loadPdf();
  </script>
</body>
</html>
