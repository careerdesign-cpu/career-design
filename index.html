<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .topbar{
      height:52px; display:flex; align-items:center; gap:10px;
      padding:0 12px; border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:sticky; top:0; z-index:10;
    }
    .btn{
      height:34px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:#e5e7eb; cursor:pointer;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .input{
      height:34px; width:64px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:#e5e7eb; text-align:center;
    }
    .spacer{flex:1}
    .wrap{height:calc(100% - 52px); display:flex}
    .sidebar{
      width:220px; border-right:1px solid rgba(255,255,255,.08);
      overflow:auto; padding:10px; box-sizing:border-box;
    }
    .thumb{
      display:block; width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03); margin-bottom:10px; cursor:pointer;
    }
    .viewer{
      flex:1; overflow:auto; display:flex; justify-content:center; align-items:flex-start;
      padding:16px; box-sizing:border-box;
    }
    canvas{
      border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:#111827;
      box-shadow:0 12px 50px rgba(0,0,0,.35);
      max-width:100%;
      height:auto;
    }
    .msg{
      position:fixed; left:50%; top:70px; transform:translateX(-50%);
      padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(239,68,68,.15); color:#fecaca; display:none; z-index:20;
      max-width:min(820px, calc(100% - 24px));
      white-space:pre-wrap;
    }
    .hint{
      position:fixed; right:12px; top:10px; z-index:30;
      font-size:12px; opacity:.8
    }
  </style>
</head>
<body>
  <div class="msg" id="msg"></div>

  <div class="topbar">
    <button class="btn" id="prev">◀</button>
    <div>
      <input class="input" id="page" value="1" />
      <span id="pageCount">/ ?</span>
    </div>
    <button class="btn" id="next">▶</button>

    <button class="btn" id="zoomOut">－</button>
    <button class="btn" id="zoomIn">＋</button>

    <div class="spacer"></div>

    <button class="btn" id="openPdf">PDF 직접열기</button>
  </div>

  <div class="wrap">
    <div class="sidebar" id="sidebar"></div>
    <div class="viewer">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <!-- ✅ pdf.js 로드 (반드시 vendor 폴더에 있어야 함) -->
  <script src="vendor/pdf.min.js"></script>
  <script>
    // ===== 설정 =====
    const PDF_URL = "assets/proposal.pdf"; // 너 레포에 있는 PDF 경로
    const WORKER_URL = "vendor/pdf.worker.min.js";

    // ===== 유틸 =====
    const $ = (id) => document.getElementById(id);
    const msg = $("msg");
    const showMsg = (t) => { msg.textContent = t; msg.style.display = "block"; };
    const hideMsg = () => { msg.style.display = "none"; };

    // ===== pdf.js 존재 체크 =====
    if (!window.pdfjsLib) {
      showMsg("pdfjsLib is not defined\n\n✅ 해결:\n1) vendor/pdf.min.js 파일이 레포에 있어야 합니다.\n2) index.html과 같은 경로로 vendor/ 폴더가 있어야 합니다.\n3) 배포 후 https://.../vendor/pdf.min.js 가 404가 아니어야 합니다.");
      throw new Error("pdfjsLib is not defined");
    }

    // 워커 경로 지정
    pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;

    // ===== 상태 =====
    let pdfDoc = null;
    let currentPage = 1;
    let scale = 1.2; // 기본 확대
    const canvas = $("canvas");
    const ctx = canvas.getContext("2d");
    const sidebar = $("sidebar");

    // ===== 렌더링 =====
    async function renderPage(pageNum) {
      hideMsg();
      const page = await pdfDoc.getPage(pageNum);

      const viewport = page.getViewport({ scale });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      const renderContext = { canvasContext: ctx, viewport };
      await page.render(renderContext).promise;

      $("page").value = String(pageNum);
      $("pageCount").textContent = `/ ${pdfDoc.numPages}`;
      currentPage = pageNum;

      // 버튼 상태
      $("prev").disabled = currentPage <= 1;
      $("next").disabled = currentPage >= pdfDoc.numPages;
    }

    // ===== 썸네일 =====
    async function buildThumbnails() {
      sidebar.innerHTML = "";
      const maxThumbWidth = 190;

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 1 });

        const thumbScale = maxThumbWidth / viewport.width;
        const thumbViewport = page.getViewport({ scale: thumbScale });

        const c = document.createElement("canvas");
        c.width = Math.floor(thumbViewport.width);
        c.height = Math.floor(thumbViewport.height);

        const cctx = c.getContext("2d");
        await page.render({ canvasContext: cctx, viewport: thumbViewport }).promise;

        c.className = "thumb";
        c.title = `Page ${i}`;
        c.addEventListener("click", () => renderPage(i));
        sidebar.appendChild(c);
      }
    }

    // ===== 로드 =====
    async function loadPdf() {
      try {
        const loadingTask = pdfjsLib.getDocument(PDF_URL);
        pdfDoc = await loadingTask.promise;

        $("pageCount").textContent = `/ ${pdfDoc.numPages}`;
        await buildThumbnails();
        await renderPage(1);
      } catch (e) {
        showMsg(
          "PDF 로딩 실패\n\n" +
          "체크리스트:\n" +
          `- ${PDF_URL} 경로가 맞는지 (직접 열어보기)\n` +
          `- ${WORKER_URL} 가 404 아닌지\n` +
          "- GitHub Pages 배포가 완료됐는지\n\n" +
          "에러:\n" + (e?.message || String(e))
        );
        console.error(e);
      }
    }

    // ===== 이벤트 =====
    $("prev").addEventListener("click", () => renderPage(Math.max(1, currentPage - 1)));
    $("next").addEventListener("click", () => renderPage(Math.min(pdfDoc.numPages, currentPage + 1)));

    $("zoomIn").addEventListener("click", async () => { scale = Math.min(3.0, scale + 0.15); await renderPage(currentPage); });
    $("zoomOut").addEventListener("click", async () => { scale = Math.max(0.6, scale - 0.15); await renderPage(currentPage); });

    $("page").addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      const n = parseInt(e.target.value, 10);
      if (!pdfDoc) return;
      if (!Number.isFinite(n) || n < 1 || n > pdfDoc.numPages) return;
      await renderPage(n);
    });

    $("openPdf").addEventListener("click", () => {
      window.open(PDF_URL, "_blank");
    });

    // 시작
    loadPdf();
  </script>
</body>
</html>